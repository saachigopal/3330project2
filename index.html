<!DOCTYPE html>

<html>

<head>
  <meta charset="UTF-8">
  <title> Movie Generator </title>
  <script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<style >
body {
        font-family: 'Avenir';
        background-color: #bcbcbc
      }
header {
    text-align: center;
}
path {
  stroke: #fff;
}
.loader{
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid grey;
  border-right: 16px solid #3498db;
  border-bottom: 16px solid grey;
  border-left: 16px solid grey;
  width: 310px;
  height: 310px;
  -webkit-animation: spin 2s linear infinite;
  animation: spin 2s linear infinite;
}
@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#summaryGenre,#summaryYear,#summaryRating,#percentage{
  position:absolute;
  left:540px;
  width: 180px;
  text-align: center;
}
#summaryGenre{
  top:400px;
}
#summaryYear{
  top:425px;
}
#summaryRating{
  top:450px;
}
#percentage{
  top:475px;
}
/* The Modal (background) */
.overlay {
    display: none; /* Hidden by default */
    /*top: -50%;*/
    /*visibility: hidden;*/
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    padding-top: 5%; /* Location of the box */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    /*transition: all .5s ease-in-out;*/
}
/* Modal Content */
.popup {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    height: 100%;
    position: relative;
}
/* Movie Poster Details CSS */
div.poster {
  display: block;
  width: 37%;
  height: 70%;
  position: relative;
  float: left;
  object-fit: fill;
  /*z-index: 2; defined in case we need it for stack order*/ 
}
/* Movie Text Details CSS */
div.right_half {
  display: flex;
  /*min-height: 120%;*/
  /*width: 50%;*/
  position: relative;
  width: 61%;
  height: 70%;
  float: left;
  flex-direction: column;
  left: 3%;
}
div.title_year {
  width: 100%;
  margin-bottom: 3%; 
  float: left;
  margin-top: 10%;
  position: relative;
}
div.title {
  height: 15%;
  width: 100%;
}
span.release_date {
  opacity: 0.6;
  font-size: 25px;
  font-weight: 400;
}
/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  margin-top: -1%;
}
.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}
</style>

    
<body>
  <header><h1 id="steps">
    Select a Genre 
  </h1>
  </header>
  <div class="container" id="summaryGenre"></div>
  <div class="container" id="summaryYear"></div>
  <div class="container" id="summaryRating"></div>
  <div class="container" id="percentage"></div>
  
  <!-- The Modal -->
  <div id="myModal" class="overlay">
  <!-- Modal pop-up for movie details-->
      <div id="modalcontent" class="popup">
        <div id= "poster_image" class= "poster"></div>
        <span class="close">&times;</span>
        <div class= "right_half">
          <div id="movie_title" class="title"> 
            <span id="movie_name" style="font-size:30px"> Example Movie  </span>
              <span id="movie_year" class= "release_date"> (1948)</span>
          
          </div>
        </div>
    </div>
  </div>
<script>
var movieData; //global variable to store json data
//Filter the json file based on genre
function filterGenre(genre){
    var genrelist=genre.split("/");
    var genres; 
    if(genrelist.length>2){
      genres=movieData.filter(d => d.Genre==genrelist[0] || d.Genre==genrelist[1] || d.Genre==genrelist[2]);
    }else if(genrelist.length>1){
       genres=movieData.filter(d => d.Genre==genrelist[0] || d.Genre==genrelist[1]);
    }else{
      genres=movieData.filter(d => d.Genre==genre);
    }
    return genres;
  }
//Filter the movies
  function filterMovie(genre,yearStart,yearEnd,rating){
    var ratinglist=rating.split("/");
    var ratings;
    var genres=filterGenre(genre);
    var year=genres.filter(d => d.Year>=yearStart && d.Year<=yearEnd);
    if(ratinglist.length>1){
       ratings=year.filter(d => d.Rated==ratinglist[0] || d.Rated==ratinglist[1]);
    }else{
      ratings=year.filter(d => d.Rated==rating);
    }
    return ratings.length;
  }
//Load the json file and parse it
d3.json("movies.json", function (error, data) {
  movieData = data;
  
  var nodeData = {
        "name": "", "children": [{
            "name": "Crime","children": [{
              "name": "1920-1960", "children": [{ 
                "name":"NR", "size":filterMovie("Crime",1920,1960,"NR")},{   
                "name":"PG/G", "size":filterMovie("Crime",1920,1960,"PG/G")},{ 
                "name":"PG-13", "size":filterMovie("Crime",1920,1960,"PG-13")},{ 
                "name":"R", "size":filterMovie("Crime",1920,1960,"R")}]},{
              "name": "1961-1990", "children": [{
                "name":"NR", "size":filterMovie("Crime",1961,1990,"NR")},{
                "name":"PG/G", "size":filterMovie("Crime",1961,1990,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Crime",1961,1990,"PG-13")},{ 
                "name":"R", "size":filterMovie("Crime",1961,1990,"R")}]},{
              "name": "1991-2016", "children": [{ 
                "name":"NR", "size":filterMovie("Crime",1991,2016,"NR")},{
                "name":"PG/G", "size":filterMovie("Crime",1991,2016,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Crime",1991,2016,"PG-13")},{
                "name":"R", "size":filterMovie("Crime",1991,2016,"R")}]}]
        }, {
            "name": "Action/Adventure","children": [{
              "name": "1920-1960", "children": [{ 
                "name":"NR", "size":filterMovie("Action/Adventure",1920,1960,"NR")},{   
                "name":"PG/G", "size":filterMovie("Action/Adventure",1920,1960,"PG/G")},{ 
                "name":"PG-13", "size":filterMovie("Action/Adventure",1920,1960,"PG-13")},{ 
                "name":"R", "size":filterMovie("Action/Adventure",1920,1960,"R")}]},{
              "name": "1961-1990", "children": [{
                "name":"NR", "size":filterMovie("Action/Adventure",1961,1990,"NR")},{
                "name":"PG/G", "size":filterMovie("Action/Adventure",1961,1990,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Action/Adventure",1961,1990,"PG-13")},{ 
                "name":"R", "size":filterMovie("Action/Adventure",1961,1990,"R")}]},{
              "name": "1991-2016", "children": [{ 
                "name":"NR", "size":filterMovie("Action/Adventure",1991,2016,"NR")},{
                "name":"PG/G", "size":filterMovie("Action/Adventure",1991,2016,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Action/Adventure",1991,2016,"PG-13")},{
                "name":"R", "size":filterMovie("Action/Adventure",1991,2016,"R")}]}]
            
        },{
            "name": "Drama/Biography","children": [{
              "name": "1920-1960", "children": [{ 
                "name":"NR", "size":filterMovie("Drama/Biography",1920,1960,"NR")},{   
                "name":"PG/G", "size":filterMovie("Drama/Biography",1920,1960,"PG/G")},{ 
                "name":"PG-13", "size":filterMovie("Drama/Biography",1920,1960,"PG-13")},{ 
                "name":"R", "size":filterMovie("Drama/Biography",1920,1960,"R")}]},{
              "name": "1961-1990", "children": [{
                "name":"NR", "size":filterMovie("Drama/Biography",1961,1990,"NR")},{
                "name":"PG/G", "size":filterMovie("Drama/Biography",1961,1990,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Drama/Biography",1961,1990,"PG-13")},{ 
                "name":"R", "size":filterMovie("Drama/Biography",1961,1990,"R")}]},{
              "name": "1991-2016", "children": [{ 
                "name":"NR", "size":filterMovie("Drama/Biography",1991,2016,"NR")},{
                "name":"PG/G", "size":filterMovie("Drama/Biography",1991,2016,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Drama/Biography",1991,2016,"PG-13")},{
                "name":"R", "size":filterMovie("Drama/Biography",1991,2016,"R")}]}]
          
        },{
            "name": "Comedy/Animation","children": [{ 
              "name": "1920-1960", "children": [{ 
                "name":"NR", "size":filterMovie("Comedy/Animation",1920,1960,"NR")},{   
                "name":"PG/G", "size":filterMovie("Comedy/Animation",1920,1960,"PG/G")},{ 
                "name":"PG-13", "size":filterMovie("Comedy/Animation",1920,1960,"PG-13")},{ 
                "name":"R", "size":filterMovie("Comedy/Animation",1920,1960,"R")}]},{
              "name": "1961-1990", "children": [{
                "name":"NR", "size":filterMovie("Comedy/Animation",1961,1990,"NR")},{
                "name":"PG/G", "size":filterMovie("Comedy/Animation",1961,1990,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Comedy/Animation",1961,1990,"PG-13")},{ 
                "name":"R", "size":filterMovie("Comedy/Animation",1961,1990,"R")}]},{
              "name": "1991-2016", "children": [{ 
                "name":"NR", "size":filterMovie("Comedy/Animation",1991,2016,"NR")},{
                "name":"PG/G", "size":filterMovie("Comedy/Animation",1991,2016,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Comedy/Animation",1991,2016,"PG-13")},{
                "name":"R", "size":filterMovie("Comedy/Animation",1991,2016,"R")}]}]
        },{
            "name": "Horror/Mystery/Sci-Fi","children": [{
              "name": "1920-1960", "children": [{ 
                "name":"NR", "size":filterMovie("Horror/Mystery/Sci-Fi",1920,1960,"NR")},{   
                "name":"PG/G", "size":filterMovie("Horror/Mystery/Sci-Fi",1920,1960,"PG/G")},{ 
                "name":"PG-13", "size":filterMovie("Horror/Mystery/Sci-Fi",1920,1960,"PG-13")},{ 
                "name":"R", "size":filterMovie("Horror/Mystery/Sci-Fi",1920,1960,"R")}]},{
              "name": "1961-1990", "children": [{
                "name":"NR", "size":filterMovie("Horror/Mystery/Sci-Fi",1961,1990,"NR")},{
                "name":"PG/G", "size":filterMovie("Horror/Mystery/Sci-Fi",1961,1990,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Horror/Mystery/Sci-Fi",1961,1990,"PG-13")},{ 
                "name":"R", "size":filterMovie("Horror/Mystery/Sci-Fi",1961,1990,"R")}]},{
              "name": "1991-2016", "children": [{ 
                "name":"NR", "size":filterMovie("Horror/Mystery/Sci-Fi",1991,2016,"NR")},{
                "name":"PG/G", "size":filterMovie("Horror/Mystery/Sci-Fi",1991,2016,"PG/G")}, { 
                "name":"PG-13", "size":filterMovie("Horror/Mystery/Sci-Fi",1991,2016,"PG-13")},{
                "name":"R", "size":filterMovie("Horror/Mystery/Sci-Fi",1991,2016,"R")}]}]
        }]
  };
var width = 960,
    height = 700,
    radius = (Math.min(width, height) / 2) - 10;
var formatNumber = d3.format(",d");
var x = d3.scaleLinear()
    .range([0, 2 * Math.PI]);
var y = d3.scaleSqrt()
    .range([0, radius]);
var color = d3.scaleOrdinal(d3.schemeCategory20);
var partition = d3.partition();
var arc = d3.arc()
    .startAngle(d => Math.max(0, Math.min(2 * Math.PI, x(d.x0))))
    .endAngle(d => Math.max(0, Math.min(2 * Math.PI, x(d.x1))))
    .innerRadius(d => Math.max(0, y(d.y0)))
    .outerRadius(d => Math.max(0, y(d.y1)));
var svg = d3.select("body").append("svg")
    .attr("id","sunburst")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(" + (width/1.55)  + "," + (height / 2) + ")");
  //Create Sunburst
  root = d3.hierarchy(nodeData);
  root.sum(function(d) { return d.size; });
  svg.selectAll("path")
      .data(partition(root).descendants())
    .enter().append("path")
      .attr("d", arc)
      .style("fill", function(d) { return color((d.children ? d : d.parent).data.name); })
    .on("mouseover",mouseover)
    .on("mouseout", mouseout)
    .on("click", handleClick)
   
    function mouseover(d){
      svg.selectAll("text").remove();
      var parent_name=d.data.name;
      var current=d;
      var iter=0;
      while(current.parent){
        iter++;
        parent_name=current.parent.data.name+"->"+parent_name;
        current=current.parent;
      }
      parent_name=parent_name.substring(2,parent_name.length);
      var topics=parent_name.split("->");
      var name="";
      if(iter==3){
        name="Click to Generate Movie";
        document.getElementById("summaryGenre").innerHTML = topics[0];
        document.getElementById("summaryYear").innerHTML = topics[1];
        document.getElementById("summaryRating").innerHTML = topics[2];
      }else if(iter==2){
        name="Select a Rating"
        document.getElementById("summaryGenre").innerHTML = topics[0];
        document.getElementById("summaryYear").innerHTML = topics[1];
      }else if(iter==1){
        name="Select a Year Range"
        document.getElementById("summaryGenre").innerHTML = topics[0];
      }else{
        name="Select a Genre"
      }
      if(iter!=0){
        document.getElementById("percentage").innerHTML = formatNumber(d.value)+ "%";
      }
      
      document.getElementById("steps").innerHTML = name;
      
      var ancestors = getAncestors(d);
      // update sunburst (Fade all the segments and highlight only ancestors of current segment)
      svg.selectAll("path")
      .attr("opacity", 0.3);
      svg.selectAll("path")
      .filter(function(node) {
        return (ancestors.indexOf(node) >= 0);
      })
      .attr("opacity", 1);
    }
    function mouseout(d){
      svg.selectAll("text").remove();
      svg.selectAll("path")
      .attr("opacity", 1);
      document.getElementById("steps").innerHTML = "Select a Genre";
      document.getElementById("summaryGenre").innerHTML = "";
      document.getElementById("summaryYear").innerHTML = "";
      document.getElementById("summaryRating").innerHTML = "";
      document.getElementById("percentage").innerHTML = "";
    }
    function handleClick(d){
      var genre=""; var year=0; var rating="";
      var topicList=[];
      var current=d;
      while(current.parent){
        topicList.push(current.data.name);
        current=current.parent;
      }
      if(topicList.length==3){
        rating=topicList[0];
        year=topicList[1];
        genre=topicList[2];
      }else if(topicList.length==2){
        year=topicList[0];
        genre=topicList[1];
      }else if(topicList.length==1){
        genre=topicList[0];
      }
      
      //Create Loader
      var newDiv = document.createElement("div")
      newDiv.className="loader";
      newDiv.id="loadbar"
      newDiv.style.position="absolute";
      newDiv.style.left = 1.34*radius+'px';
      newDiv.style.top = height/2.64+'px';
      document.body.appendChild(newDiv);
      var selectedMovie;
      //Create Delay for Loader
      setTimeout(function(){
        //Generate movie and create form with movie summary
        selectedMovie=generateMovie(genre,year,rating);
        console.log(selectedMovie);
        
        //Display the modal
        var modal = document.getElementById('myModal');
        modal.style.display = "block";
        // modal.style.visibility = "visible";
        //Fill in the content
        d3.select("#poster_image").append("img")
        .attr("id","poster_img")
        .attr("width", "100%")
        .attr("height","100%")
        .attr("alt",selectedMovie.Title)
        .attr("class","poster")
        .attr("src",selectedMovie.Poster);
        // var movieTitle = d3.select("#movie_title").append("span")
        // .attr("id","movie_title_text")
        // .attr("height","100%")
        // // .attr("font-size", "100%")
        // .text(selectedMovie.Title);
        d3.select("#movie_name").text(selectedMovie.Title);
        // movieTitle.append("span")
        // .attr("id","release_date")
        // .attr("class","release_date")
        // .text(" ("+selectedMovie.Year+")");
        // }, 1200); 
        d3.select("#movie_year").text(" ("+selectedMovie.Year+")");
      }, 1200); 
      
    }
    // Function used to generate movie suggestion based on inputs
    function generateMovie(Genre,Year,Rating){
      var movies=filterGenre(Genre);
      if(Year!=""){
        var years=Year.split("-");
        movies=movies.filter(function(d){return d.Year>=Number(years[0]) && d.Year<=Number(years[1])});
      }
      if(Rating !=""){
        ratings=Rating.split("/")
        movies=movies.filter(function(d){ 
       return d.Rated==ratings[0] || d.Rated==ratings[1]});
      }
      var loader=document.getElementById("loadbar");
      loader.parentNode.removeChild(loader);
      return movies[Math.floor(Math.random()*movies.length)];
    }
    function getAncestors(node) {
    var path = [];
    var current = node;
    while (current.parent) {
      path.unshift(current);
      current = current.parent;
    }
    return path;
  }
});
// Code for closing the modal. Model will close if the x is clicked or anywhere outside of the modal is clicked. 
// Credits: this functionality was based off the modal tutorial on w3schools.
// Get the modal and get the <span> element that closes the modal
var modal = document.getElementById('myModal');
var closeModal = document.getElementsByClassName("close")[0];
//Remove the added modal content
function removeModalContent () {
  d3.select("#poster_img").remove();
  // d3.select("#movie_title_text").remove();
  // d3.select("#release_date").remove();
}
// When the user clicks on <span> (x), close the modal
closeModal.onclick = function() {
    modal.style.display = "none";
    // modal.style.visibility = "hidden";
    removeModalContent();
}
// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
        // modal.style.visibility = "hidden";
        removeModalContent();
    }
  }
</script>

<div id="plot" style="text-align: center">
<body>
<script>    
var color = d3.scaleOrdinal(d3.schemeCategory20);
var filmstats;
d3.json("movies.json", function(data) {
    filmstats = data;
    console.log(filmstats);
    showGraph();
});
    
function showGraph() {
    var svg2 = d3.select("body").append("svg")
        .attr("id", "graph")
        .attr("width", "750")
        .attr("height", "750")
    .attr("align","center");
    var xscale = d3.scaleLinear().domain([0,600]).range([0,660]);
    var yscale = d3.scaleLinear().domain([0,12]).range([660,0]);
    var xaxis = d3.axisBottom(xscale);
    var yaxis = d3.axisLeft(yscale);
    svg2.append("g").attr("transform", "translate(50,670)").call(xaxis);
    svg2.append("g").attr("transform", "translate(50,10)").call(yaxis);
    svg2.append("text").text("Box Office Returns (Million $)")
        .attr("x","250")
        .attr("y","720")
        .style("font-family","avenir")
        .style("font-size","16");
    svg2.append("text").text("Academy Awards Won")
        .attr("x","0")
        .attr("y","200")
        .attr("transform", "translate(-185, 450) rotate(-90)")
        .style("font-family","avenir")
        .style("font-size","16");
    for (var i=0; i < filmstats.length; i++) {
        svg2.append("circle")
        .attr("cx", 50+xscale(filmstats[i].BoxOffice/1000000))
        .attr("cy", 10+yscale(filmstats[i].OscarsWon))
        .attr("r", 10)
        .attr("fill", d=>color(i))
        .attr("fill-opacity", "0.5")
        .attr("stroke","none");

    }
};

var comedy = document.createElement("button");
var t0 = document.createTextNode("Comedy/Animation");
comedy.append(t0);
document.body.appendChild(comedy);
    
comedy.addEventListener("click", function() { 
    var filter = d3.select("svg2").selectAll("circle").data(
    filmstats.filter(function(d) {return d.Genre == "Comedy";})); 
    d3.select("svg2").selectAll("*").remove();
//    d3.select("svg2").selectAll("circles").enter().
    for (var i=0; i < filter.length; i++) {
        svg2.append("circle")
        .attr("cx", 50+xscale(filter[i].BoxOffice/1000000))
        .attr("cy", 10+yscale(filter[i].OscarsWon))
        .attr("r", 10)
        .attr("fill", d=>color(i))
        .attr("fill-opacity", "0.5")
        .attr("stroke","none");
    }

});


var drama = document.createElement("button");
var t1 = document.createTextNode("Drama/Biography");
drama.append(t1);
document.body.appendChild(drama);

var action = document.createElement("button");
var t2 = document.createTextNode("Action/Adventure");
action.append(t2);
document.body.appendChild(action);
    
var crime = document.createElement("button");
var t3 = document.createTextNode("Crime");
crime.append(t3);
document.body.appendChild(crime);

var horror = document.createElement("button");
var t4 = document.createTextNode("Horror/Mystery/Sci-Fi");
horror.append(t4);
document.body.appendChild(horror);   
    
    
</script>    
    

</html>
